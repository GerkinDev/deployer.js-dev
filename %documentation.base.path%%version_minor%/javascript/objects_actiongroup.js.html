<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: objects/actiongroup.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: objects/actiongroup.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file A group of executable sub-groups/actions
 *
 * @author Gerkin
 * @copyright 2016 %company.name%
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPLv3
 * @package deployer.js
 *
 * @version %version%
 */

'use strict';

const CommandAction = require("./commandaction.js");
const Breadcrumb = require("./breadcrumb.js");
const Arguments = require('./arguments.js');


/**
 * @typedef ActionGroupChild
 * @type   {CommandAction|ActionGroup}
 */

/**
 * Creates a new ActionGroup
 * @class ActionGroup
 * @param   {object}   config Configuration of the action group
 * @param   {ActionGroup.Mode} config.mode Type of async execution of the command group
 * @param   {ActionGroupChild[]} config.actions Sub action groups or child actions
 */
class ActionGroup{
    constructor ({args,mode,actions}){
        if(is_na(arguments[0]))
            throw new Error("Can't create ActionGroup with null or undefined config.");

        var _mode,
            _actions,
            _args;

        Object.defineProperties(this, {
            /**
             * @member {ActionGroup.Mode} mode
             * @memberof ActionGroup
             * @public
             * @instance
             */
            mode: {
                get: function(){
                    return _mode;
                },
                set: function(val){
                    if(Object.keys(ActionGroup.Mode).indexOf(val) != -1){
                        _mode = ActionGroup.Mode[val];
                        return _mode;
                    } else if(Object.values(ActionGroup.Mode).indexOf(val) != -1){
                        _mode = val;
                        return _mode;
                    } else {
                        return undefined;
                    }
                }
            },
            /**
             * @member {ActionGroupChild[]} actions
             * @memberof ActionGroup
             * @public
             * @instance
             */
            actions: {
                get: function(){
                    return _actions;
                },
                set: function(val){
                    if(is_na(val))
                        return undefined;
                    if(val.constructor.name != "Array")
                        return undefined;

                    var ok = true;
                    for(var i = 0, j = val.length; i &lt; j; i++){
                        ok &amp;= (val[i].constructor.name == "ActionGroup") || (val[i].constructor.name == "CommandAction");
                    }
                    if(!ok)
                        return undefined;

                    _actions = val;
                    return val;
                }
            },
            /**
             * @member {Arguments} arguments
             * @memberof ActionGroup
             * @public
             * @instance
             */
            arguments: {
                get: function(){return _args;},
                set: function(newArgs){
                    if(!(newArgs instanceof Arguments))
                        throw new TypeError(`Setter of "ActionGroup.arguments" expects object of type "Arguments", "${ typeof newArgs }" given.`);
                    _args = newArgs;
                }
            }
        });
        this.arguments = new Arguments(args);

        if(mode === "parallel"){
            _mode = ActionGroup.Mode.PARALLEL;
        } else if(mode === "serie"){
            _mode = ActionGroup.Mode.SERIE;
        } else {
            throw new Error('Could not resolve ActionGroup type: "parallel" or "serie"');
        }

        var actionsGroupChild = [];
        for(var i = 0, j = actions.length; i &lt; j; i++){
            var actionGroupChildConfig = actions[i];
            var actionGroupChild = null;

            if(actionGroupChild === null &amp;&amp; ActionGroup.test(actionGroupChildConfig)){
                try{
                    actionGroupChild = new ActionGroup(actionGroupChildConfig);
                } catch(e){
                    deployer.log.warn("ActionGroup said it can parse an object it failed on:", JSON.stringify(actionGroupChildConfig))
                }
            }
            if(actionGroupChild === null &amp;&amp; CommandAction.test(actionGroupChildConfig)){
                try{
                    actionGroupChild = new CommandAction(actionGroupChildConfig);
                } catch(e){
                    deployer.log.warn("CommandAction said it can parse an object it failed on:", JSON.stringify(actionGroupChildConfig), e);
                }
            }
            if(actionGroupChild === null){
                throw "Could not parse ActionGroup child: " + JSON.stringify(actionGroupChildConfig);
            }
            //console.log(actionGroupChild);
            actionsGroupChild.push(actionGroupChild);
        }
        this.actions = actionsGroupChild;

        if(is_na(this.mode) || is_na(this.actions) || this.actions.length &lt; 1){
            throw new Error("Properties not correctly initialized");
        }
    }

    /**
     * @function test
     * @memberof ActionGroup
     * @description Check if given object is ok to be parsed by {@link ActionGroup constructor}
     * @param   {object} config The object to test
     * @returns {boolean} True if ok, false otherwise
     * @static
     * @public
     * @author Gerkin
     */
    static test (config){
        return (!is_na(config.mode)) &amp;&amp; (typeof config.mode == "string") &amp;&amp; (!is_na(config.actions)) &amp;&amp; (config.actions.constructor.name == "Array");
    }

    /**
     * @method execute
     * @memberof ActionGroup
     * @description todo
     * @param   {Breadcrumb} breadcrumb The actions breadcrumb
     * @param   {Function} callback   Function to call afterwards
     * @returns {undefined} Async
     * @instance
     * @public
     * @author Gerkin
     * @see {@link Arguments.brewArguments}
     */
    execute (breadcrumb, next){
        breadcrumb.startTimer();
        deployer.log.info("Starting ActionGroup " + breadcrumb.toString());
        var mode;

        switch(this.mode){
            case 1:{
                mode = "forEachOf";
            } break;

            case 2:{
                mode = "forEachOfSeries";
            } break;
        }

        return this.arguments.brewArguments((values)=>{
            console.log(values, this.arguments);
            async[mode](this.actions, (action, index, callback)=>{
                action.setArguments(this.arguments).execute(breadcrumb.clone().push(index), callback);
            }, function(){
                deployer.log.info("Ended ActionGroup " + breadcrumb.toString() + " after " + breadcrumb.getTimer() + "ms");
                return next();
            });
        });
    }
    /**
     * @function setArguments
     * @memberof ActionGroup
     * @description Prepare {@link ActionGroup#arguments} by setting its {@link Arguments#ancestor} for placeholder operations
     * @param   {Arguments} arg The argument object to put as ancestor
     * @instance
     * @public
     * @author Gerkin
     */
    setArguments (arg){
        if(!(arg instanceof Arguments))
            throw new TypeError(`Function "setArguments" expects object of type "Arguments", "${ typeof arg }" given.`);
        this.arguments.ancestor = arg;
        return this;
    }
}
/**
 * @readonly
 * @enum {number}
 */
ActionGroup.Mode = {
    PARALLEL: 1,
    SERIE: 2
}

module.exports = ActionGroup;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-actions_cp.html">actions/cp</a></li><li><a href="module-actions_exec.html">actions/exec</a></li><li><a href="module-actions_files-version.html">actions/files-version</a></li><li><a href="module-actions_git.html">actions/git</a></li><li><a href="module-actions_less-compile.html">actions/less-compile</a></li><li><a href="module-actions_minify.html">actions/minify</a></li><li><a href="module-actions_svn.html">actions/svn</a></li><li><a href="module-actions_version-history.html">actions/version-history</a></li><li><a href="module-actions_wordpress-upgrade.html">actions/wordpress-upgrade</a></li><li><a href="module-deployer.html">deployer</a></li></ul><h3>Classes</h3><ul><li><a href="ActionGroup.html">ActionGroup</a></li><li><a href="Arguments.html">Arguments</a></li><li><a href="Breadcrumb.html">Breadcrumb</a></li><li><a href="Command.html">Command</a></li><li><a href="CommandAction.html">CommandAction</a></li><li><a href="ComputedArgument.html">ComputedArgument</a></li><li><a href="Listener.html">Listener</a></li><li><a href="ListenerAction.html">ListenerAction</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deployer">deployer</a></li><li><a href="global.html#getFilesRec">getFilesRec</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Tue May 17 2016 18:02:33 GMT-1000 (TAHT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
