/**
 * @file Global functions used through Deployer.js package
 * @description Retrieve all files from path, excluding ones in the {@link deployer}.config.excludeExplore
 *
 * @author false
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPL v3
 * @package deployer.js
 *
 * @version 0.2.2
 */
function deepReplacePlaceholder(e,r,n){for(var o=Object.keys(n),t=0,c=o.length;c>t;t++){var l=o[t],i=n[l];r="String"==i.constructor.name?r.replace(new RegExp("([^\\\\]|^)%"+e+l+"%","gm"),"$1"+i):deepReplacePlaceholder(e+l+".",r,i)}return r}throwError=function(e,r){},getFilesRec=function(e,r){var n=[],o={};fs.readdir(e,function(t,c){t&&throwError(t),async.each(c,function(r,t){var c=e+"/"+r,l=c.replace(process.cwd(),".");fs.stat(c,function(e,i){if(e)throwError(e);else if(i.isDirectory()){for(var u=!0,a=0,f=deployer.config.excludeExplore.length&&u;f>a;a++){var s=deployer.config.excludeExplore[a];l.match(new RegExp(s))&&(u=!1)}u?getFilesRec(c,function(e,n){e&&throwError(e),o[r]=n,t()}):t()}else n.push(r),t()})},function(e){Object.keys(o).length>0&&n.push(o),r(e,n)})})},checkFiles=function(e,r,n,o,t){"undefined"==typeof o&&(o="."),"undefined"==typeof t&&(t=!1);for(var c in e){var l=(o+"/"+c).match(r);(t||l)&&("boolean"==typeof e[c]?e[c]=n:e[c].included=n),"boolean"!=typeof e[c]&&(e[c].files=checkFiles(e[c].files,r,n,o+"/"+c,t||l))}return e},filesFromSelectors=function(e){for(var r=reformatFiles(deployer.files),n=Object.keys(e),o=0,t=n.length;t>o;o++){var c=n[o];try{var l=new RegExp(c)}catch(i){deployer.log.error(i)}r=checkFiles(r,l,e[c])}var u=filesStructToArray(r);return u},reformatFiles=function(e){for(var r={},n=0,o=e.length;o>n;n++)if("object"==typeof e[n])for(var t=Object.keys(e[n]),c=0,l=t.length;l>c;c++)r[t[c]]={included:!1,files:reformatFiles(e[n][t[c]])};else r[e[n]]=!1;return r},filesStructToArray=function(e,r){"undefined"==typeof r&&(r=".");var n=[];for(var o in e){var t=r+"/"+o;"boolean"==typeof e[o]?e[o]&&n.push(t):n=n.concat(filesStructToArray(e[o].files,t))}return n},replacePlaceHolders=function(e,r){if(null==e)return e;if("object"==typeof e&&null!=e&&e.constructor!=Array){var n={};for(var o in e)n[o]=replacePlaceHolders(e[o],r);return n}if(e.constructor==Array){for(var n=[],o=0,t=e.length;t>o;o++)n.push(replacePlaceHolders(e[o],r));return n}return"string"==typeof e?deepReplacePlaceholder("",e,r):e},mkdir=function(e,r){var n=e.split("/"),o=n.shift(),r=(r||"")+o+"/";try{fs.mkdirSync(r)}catch(t){if(!fs.statSync(r).isDirectory())throw new Error(t)}return!n.length||mkdir(n.join("/"),r)},composeUrl=function(e,r,n){var o=deployer.config.project.documentation.format.slice(r,n).join("/");return"url"==e.base?o=o.replace("%BASE%",deployer.config.project.documentation.base.url):"path"==e.base&&(o=o.replace("%BASE%",deployer.config.project.documentation.base.path)),e.type&&(o=o.replace("%TYPE%",e.type)),o},readLocalConfigFile=function(e){var r=path.resolve(".",deployer.config.configFile);fs.readFile(r,"UTF-8",function(n,o){if(n)return e(n);try{var t=JSON.parse(o)}catch(c){return deployer.log.warn("Invalid JSON file "+r,c),e(c)}return e(null,t)})},writeLocalConfigFile=function(e,r){var n=path.resolve(".",deployer.config.configFile);fs.writeFile(n,JSON.stringify(e,null,4),function(e){r(e)})},getModuleVersion=function(e,r){deployer.config.moduleVersion||(deployer.config.moduleVersion={}),fs.readFile(path.resolve(e.match(/\.js$/)?e:e+".js"),"UTF-8",function(n,o){if(n)deployer.log.error('Could not find module "'+e+'"'),deployer.config.moduleVersion[e]="unknown";else{var t=o.match(/^\/\*\*(?:\s*\*\s*(?:(@version.*)|.*)?)+\//m);t[1]&&o.indexOf(t)<o.indexOf("*/")?deployer.config.moduleVersion[e]=t[1].replace(/@version\s+/,""):(replacePlaceHolders,deployer.config.moduleVersion[e]="unknown")}r()})};var enqueuedPrompts=[],runningPromp=null;requestPrompt=function(e,r){null==runningPromp?(runningPromp={question:e,cb:r},rl.question(e,function(e){if(runningPromp.cb(e),runningPromp=null,enqueuedPrompts.length>0){var r=enqueuedPrompts[0];return enqueuedPrompts=enqueuedPrompts.slice(1),requestPrompt(r.question,r.cb)}})):enqueuedPrompts.push({question:e,cb:r})},transformArguments=function(e,r,n){r=replacePlaceHolders(r,e);var o=merge(e,!0);async.forEachOf(r,function(e,r,n){if(!e||!e.constructor||"Object"!==e.constructor.name)return o[r]=e,n();switch(e.type){case"regex_replace":return o[r]=e.value.replace(new RegExp(e.search),e.replacement),n();case"prompt":return requestPrompt('Please provide a value for argument "'+r+'": ',function(e){return o[r]=e,n()})}},function(e){n(e,o)})};