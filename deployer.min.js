/**
 * @file deployer.js Global deployment handler
 * @description false
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPL v3
 * @package deployer.js
 *
 * @version 0.2.2
 */
function composeLog(e,o){var n=[];n[0]=o[0],n[1]=o[1];for(var r in e)n.push(e[r]);return n}function handleCli(e){return e.configFile=cli.opts().config_file,e.globalConfigFile=cli.opts().global_config_file,cli.opts().log_level&&(e.loglevel=cli.opts().log_level),init=!1,e}function parseConfig(e,o,n){"undefined"!=typeof e&&null!=e||(e=[]),e.constructor!=Array&&(e=[e]),"undefined"!=typeof o&&null!=o||(o=[]),o.constructor!=Array&&(o=[o]);async.parallel({global:function(o){async.mapSeries(e,function(e,o){parseFile(e,!0,o)},function(e,n){e&&deployer.log.error(e),o(e,n)})},local:function(e){async.mapSeries(o,function(e,o){parseFile(e,!1,o)},function(o,n){o&&deployer.log.error(o),e(o,n)})}},function(e,o){n(e,handleCli(merge.recursive(merge.recursive.apply([],o.global),merge.recursive.apply([],o.local))))})}function parseFile(e,o,n){var r;async.waterfall([function(n){r=path.resolve(o?__dirname:".",e),fs.access(r,fs.W_OK,n)},function(e){deployer.log.verbose("Found "+(o?"GLOBAL":"LOCAL")+" config file "+r),fs.readFile(r,"UTF-8",e)},function(e,n){try{var l=JSON.parse(e);return n(null,l)}catch(i){return deployer.log.error("Parse error of "+(o?"GLOBAL":"LOCAL")+" config file "+r+": ",i),n(i,{})}}],function(e,o){n(e,handleCli(o))})}function reformatHelp(e){return e=e.replace(/\s*Usage:.*(\s*^\s*$\s)*/gm,"").replace(/\s*Options(\s|.)*/gm,""),e=colour.italic(e),"\n"+e+"\n\n"}function dryHelp(){const e=new commander.Command;e.command("help").description("Output the help.").action(function(){innerCli.outputHelp(reformatHelp)});for(var o in deployer.config.project.commands){var n=deployer.config.project.commands[o];deployer.log.silly("Registering command "+o),e.command(o).description((n.description?n.description:"")+(n.description&&n.awake?" - ":"")+(n.awake?colour.underline("Open listening CLI"):""))}e.help(reformatHelp)}function run(e){"undefined"==typeof e&&(e=!1),deployer.log.verbose('Executing action "'+deployer.config.action+'"');deployer.config.base_path=__dirname,async.series([function(e){return parseConfig(deployer.config.globalConfigFile,deployer.config.configFile,function(o,n){deployer.config=merge.recursive(deployer.config,n),console.log(deployer.config),o&&deployer.log.error(o),cli.opts().dump_config&&deployer.log.always("Configuration: "+JSON.stringify(deployer.config,null,4)),e()})},function(e){return getFilesRec(process.cwd(),function(o,n){deployer.files=n,e(o)})}],function(o){if(e)dryHelp();else{var n=deployer.config.project.commands[deployer.config.action];n?n.awake?runPermanentCli():execCommandRoot(deployer.config.action,function(){}):deployer.log.error('Tried to launch Deployer with unexistent action "'+deployer.config.action+'"')}})}function runPermanentCli(){const e=new commander.Command;var o=null,n=!1;e.command("help [command]").description("Output the help. [command] is optionnal.").action(function(n){if("undefined"==typeof n){if(e.outputHelp(reformatHelp),null!=o&&"Function"==o.constructor.name)return o()}else console.log("Requested help for ",n)}),e.command("exit").description("Exit the program").action(function(){n=!0,null!=o&&"Function"==o.constructor.name&&o()}),e.on("*",function(n){return console.log(),deployer.log.info("Command "+colour.red(n)+" does not exist"),e.outputHelp(reformatHelp),null!=o&&"Function"==o.constructor.name?o():void 0});for(var r in deployer.config.project.commands){var l=deployer.config.project.commands[r];if(!l.awake){deployer.log.verbose("Registering command "+r);var i,t="";l.arguments&&Object.keys(l.arguments).length&&(deployer.log.verbose("Command "+r+" have arguments."),t=colour.bold("For more informations, run "+colour.blue("help "+r))),i=l.description?e.command(r).description(l.description+"    "+t):e.command(r).description(t);for(var c in l.arguments){var a=l.arguments[c]?l.arguments[c]:"No description available";i.option("--"+c,a)}i.action(function(){var e=r;return function(){null!=o&&"Function"==o.constructor.name&&execCommandRoot(e,o)}}())}}deployer.log.silly("Running pre-listen actions"),execCommandRoot(deployer.config.action,function(r){deployer.log.silly("Pre-listen actions done"),e.outputHelp(reformatHelp),rl.setPrompt(colour.green(colour.bold("    => "))),rl.on("close",function(){process.exit(0)}),async.doUntil(function(n){rl.prompt(),rl.on("line",function(r){var l=[process.argv[0],process.argv[1]].concat(spawnargs(r));rl.pause(),rl.removeAllListeners("line"),o=n,e.parse(l)})},function(){return n},function(){deployer.log.always("Exiting..."),rl.close()})})}function execCommandRoot(e,o){var n=deployer.config.project.commands;if(n[e]){deployer.log.silly('Running command "'+e+'".');var r=n[e];if(deployer.log.verbose('Command "'+e+'" config:',r),r.awake)for(var l=[],i=0,t=r.actions.length;t>i;i++){var c=r.actions[i];if(c.events){console.log(c,"is event listener"),l.unshift(i);var a=require("./actions/"+c.action+".js"),s=a.processSingle;if("function"==typeof s)for(var u in c.events){var p=filesFromSelectors(c.events[u]);console.log("For event ",u,p);for(var f=0,d=p.length;d>f;f++)switch(u){case"onchange":var g=path.resolve(".",p[f]);fs.watch(path.resolve(".",p[f]),function(){var e=g,o=c.data,n=s;return function(){n(o,e,nextSingleProcess)}}())}}else console.log("Action "+c.action+" have no processSingle function")}else console.log(c,"is runnable action")}if(r.command_group){var m=merge.recursive(deployer.config.project.arguments,!0);return deployer.log.always("Arguments from config:",m),"undefined"!=typeof r.arguments&&null!=r.arguments&&"Object"==r.arguments.constructor.name?transformArguments(m,r.arguments,function(e,n){return execCommandGroup(r,n,"",o)}):execCommandGroup(r,m,"",o)}}else deployer.log.error('Command "'+e+'" is not configured.');"undefined"!=typeof o&&(deployer.log.info("Listen"),o())}function nextSingleProcess(e,o){if(e.next&&e.next.action){var n=e.next,r=require("./actions/"+n.action+".js"),l=r.processSingle;"function"==typeof l&&l(n.data,o,nextSingleProcess)}}function execCommandGroup(e,o,n,r){console.log("Command:",e),console.log("Arguments:",o);var l=e.actions.length>0,i=["serie","parallel"].indexOf(e.mode)>-1;if(l^i)deployer.log.error("Misconfigured command group "+n+": missing action or mode"),r();else if(l||i){n&&(n+=".");var t="serie"==e.mode?"forEachOfSeries":"forEachOf";deployer.log.silly("Executing in mode "+t),async[t](e.actions,function(e,r,l){transformArguments(o,e.arguments,function(o,i){function t(){var o=(new Date).getTime();deployer.log.info("====> Starting action "+n+r+": "+e.action);var t=replacePlaceHolders(e.data,i);return c.process(t,function(){return deployer.log.info("====> Finished action "+r+": "+e.action+" after "+((new Date).getTime()-o)+"ms"),l()})}if(console.log("ArgumentsChild",i),e.command_group)execCommandGroup(e,i,n+r,l);else{deployer.log.silly("Action: ",JSON.stringify(e));var c=require("./actions/"+e.action+".js");if(!c){var o='Action "'+e.action+'" not found!';return deployer.log.error(o),l(o)}if(!c.process){var o='Action "'+e.action+'" has no method '+colour.italic("process")+"!";return deployer.log.error(o),l(o)}if("undefined"!=typeof c.arguments&&null!=c.arguments){var a;a="Function"==c.arguments.constructor.name?c.arguments(e.data):c.arguments,"undefined"!=typeof a&&null!=a&&"Array"!=a.constructor.name&&(a=[a]),deployer.log.verbose("Action "+e.action+" requires following args: ",a),console.log(i),a=a.filter(function(e){return-1==Object.keys(i).indexOf(e)}),async.each(a,function(o,n){requestPrompt('Please provide a value for action argument "'+o+'" in action "'+e.action+'": ',function(e){i[o]=e,n()})},function(){console.log("Dump all",i),t()})}else t()}})},function(e){console.log("Ended level "+n),e&&deployer.log.error(e),r(e)})}else deployer.log.silly("Empty command, return"),r()}fs=require("fs"),child_process=require("child_process"),async=require("async"),colour=require("colour"),merge=require("merge"),path=require("path");const commander=require("commander"),cli=new commander.Command,readline=require("readline");rl=readline.createInterface({input:process.stdin,output:process.stdout}),rl.pause();const spawnargs=require("spawn-args");require("./utils.js");var init=!0;process.on("uncaughtException",function(e){deployer.log.error(e.stack)}).on("unhandledRejection",function(e){deployer.log.error(e.stack)}),deployer={log:{levels:["silly","verbose","info","warn","error","silent"],silly:function(e){deployer.log.custom.apply(this,composeLog(arguments,{0:"rainbow",1:"silly"}))},verbose:function(e){deployer.log.custom.apply(this,composeLog(arguments,{0:"blue",1:"verbose"}))},info:function(e){deployer.log.custom.apply(this,composeLog(arguments,{0:"cyan",1:"info"}))},warn:function(e){deployer.log.custom.apply(this,composeLog(arguments,{0:"yellow",1:"warn"}))},error:function(e){deployer.log.custom.apply(this,composeLog(arguments,{0:"red",1:"error"}))},always:function(e){deployer.log.custom.apply(this,composeLog(arguments,{0:"gray",1:"silent"}))},custom:function(e){var o=arguments[1],n=arguments[0];if(deployer.log.levels.indexOf(o)>=deployer.log.levels.indexOf(deployer.config.loglevel||init)){var r=[];r[0]=colour[n](o.charAt(0).toUpperCase()+o.slice(1)+":");for(var l=2,i=arguments.length;i>l;l++)r[l-1]=arguments[l];console.log.apply(console.log,r),deployer.log.levels.indexOf(o)>=deployer.log.levels.indexOf("warn")&&"silent"!=o&&console.trace()}}},config:{loglevel:"silly",excludeExplore:["^.\\/node_modules($|\\/.+)"],project:{commands:{_default:{awake:!0}}},action:"_default"}},getModuleVersion("deployer",function(){cli.version(deployer.config.moduleVersion.deployer),cli.option("-d, --dump_config","Dump the compiled config file",!1),cli.option("-l, --log_level <level>","Set the log level",/^(silly|verbose|info|warn|error|silent)$/i,!1),cli.option("-g, --global_config_file <path>","Will use the file <path> as global base config file",/.*\.json(?![^a-zA-Z])$/,"config.global.json"),cli.option("-c, --config_file <path>","Will use the project file <path>",/.*\.json(?![^a-zA-Z])$/,"deployer_config.json"),cli.command("dry-run").description("Get help for commands available with current config").action(function(){handleCli(deployer.config),deployer.config.action=null,run(!0)}),cli.command("help").description("Get help for commands & options").action(function(){handleCli(deployer.config),deployer.config.action=null,cli.outputHelp()}),cli.command("*").description("The name of the command you want to use").action(function(e){handleCli(deployer.config),deployer.config.action=e,run()}),cli.parse(process.argv),0==cli.args.length&&(handleCli(deployer.config),run())});