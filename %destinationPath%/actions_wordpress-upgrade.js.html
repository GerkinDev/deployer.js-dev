<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: actions/wordpress-upgrade.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: actions/wordpress-upgrade.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Upgrades WordPress plugin infos
 * @description Upgrades WordPress plugin infos
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPL v3
 * @package deployer.js
 *
 */

const randomstring = require("randomstring");

/**
 * @todo description {@link deployer}
 * @module actions/wordpress-upgrade
 * @requires fs
 * @requires randomstring
 */
module.exports = {
	/**
     * Process the generation operation with the config provided
	 * @method
     * @param   {object} config Options to explain to the module how to behave
     * @param   {callback} Function to call at the end of action
     * @returns {undefined}
     */
	process: function(config, cb){
		var versions = {};
		var fileContents = {};
		async.parallel([
			function(cb1){
				var file = "readme.txt";
				var fp = path.resolve(".", file);
				fs.access(fp, fs.W_OK | fs.R_OK, function(err){
					if(err)
						return cb1(err);
					fs.readFile(fp, 'UTF-8', function(err, out){
						if(err)
							return cb1(err);
						var regex = /^(Stable tag:\s*)(\d+[\.\d+]*)$/mi;
						var matched = regex.exec(out);
						if(matched){
							var matched = matched[0];
							versions[file] = matched.replace(regex, "$2");
							fileContents[file] = out.replace(regex, "$1" + deployer.config.version);
							return cb1();
						} else {
							return cb1("WORDPRESS-UPGRADE => \"Stable tag\" not found in \"readme.txt\"");
						}
					});
				});
			},
			function(cb1){
				var file = new RegExp(deployer.config.project.project_name.replace(/[\W]/g, ".?") + "\\.php", "i");
				for(var i = 0, j = deployer.config.files.length; i &lt; j &amp;&amp; file.constructor.name != "String"; i++){
					if(deployer.config.files[i].match &amp;&amp; deployer.config.files[i].match(file))
						file = deployer.config.files[i];
				}
				if(file.constructor.name != "String"){
					return cb1("WORDPRESS-UPGRADE => Could not find which file is the main file.");
				}
				var fp = path.resolve(".", file);
				fs.access(fp, fs.W_OK | fs.R_OK, function(err){
					if(err)
						return cb1(err);
					fs.readFile(fp, 'UTF-8', function(err, out){
						if(err)
							return cb1(err);
						var regex = /^(Version:\s*)(\d+[\.\d+]*)$/mi;
						var matched = regex.exec(out);
						if(matched){
							var matched = matched[0];
							versions[file] = matched.replace(regex, "$2");
							fileContents[file] = out.replace(regex, "$1" + deployer.config.version);
							return cb1();
						} else {
							return cb1("WORDPRESS-UPGRADE => \"Version\" not found in \"" + file + "\"");
						}
					});
				});
			}
		], function(err){
			if(err){
				deployer.log.error(err);
				return cb(err);
			}
			async.series({
				changelog: function(cb1){
					var swapName = "changelog_" + randomstring.generate(15);
					var swapPath = path.resolve("/tmp", swapName);
					var args = config.command.args.slice(0);
					for(var i = 0, j = args.length; i &lt; j; i++){
						args[i] = args[i].replace(/%FILE%/g, swapPath);
					}
					textEditor(swapPath, "\n\n# Please enter changelog for version "+deployer.config.version+"\n# Lines beginning with # will be ignored.\n# Empty message will abort publication\n# " + config.command.closeMessage, {bin: config.command.bin, args: args}, function(err, content){
						if(err)
							deployer.log.error("WORDPRESS-UPGRADE => Error while executing text editor for changelog...", err);
						content = content.replace(/^[\t\f ]*#.*$/gm, "").replace(/[\r\n]+([\r\n])/g, "$1");
						content = content.replace(/^[\r\n\f]+|[\r\n\f]+$/,"").trim();
						if(content == ""){
							deployer.log.error("WORDPRESS-UPGRADE => Empty changelog, abort");
							return cb1("EXIT","");
						}
						cb1(err,content);
					});
				},
				upgrade_notice: function(cb1){
					var swapName = "upgrade_notice_" + randomstring.generate(15);
					var swapPath = path.resolve("/tmp", swapName);
					var args = config.command.args.slice(0);
					for(var i = 0, j = args.length; i &lt; j; i++){
						args[i] = args[i].replace(/%FILE%/g, swapPath);
					}
					textEditor(swapPath, "\n\n# Please enter Upgrade Notice for version "+deployer.config.version+"\n# Lines beginning with # will be ignored.\n# " + config.command.closeMessage, {bin: config.command.bin, args: args}, function(err, content){
						if(err)
							deployer.log.error("WORDPRESS-UPGRADE => Error while executing text editor for changelog...", err);
						content = content.replace(/^[\t\f ]*#.*$/gm, "").replace(/[\r\n]+([\r\n])/g, "$1");
						content = content.replace(/^[\r\n\f]+|[\r\n\f]+$/,"").trim();
						cb1(err,content);
					});
				}
			}, function(err, out){
				if(err){
					deployer.log.error("WORDPRESS-UPGRADE => Error while getting new readme infos:", err);
					return cb(err);
				}
				var files = Object.keys(versions);
				if(versions[files[0]] == versions[files[1]]){
					async.each(files, function(file, cb2){
						var fp = path.resolve(".", file);
						var content = fileContents[file];
						if(file.match(/readme\.txt$/)){
							var version_header = "= " + deployer.config.version + " =\n";
							var version_headers = [];
							var index = -1;
							while((index = content.indexOf(version_header, index + 1)) >= 0){
								version_headers.push(index);
							}

							var indexOf = {
								changelog: content.indexOf("== Changelog =="),
								upgrade_notice: content.indexOf("== Upgrade Notice ==")
							};

							var idx;
							if((indexOf.changelog &lt; indexOf.upgrade_notice &amp;&amp; (idx = version_headers.filter(function(elem){
								return elem > indexOf.changelog &amp;&amp; elem &lt; indexOf.upgrade_notice;
							})).length > 0) || (indexOf.changelog > indexOf.upgrade_notice &amp;&amp; (idx = version_headers.filter(function(elem){
								return elem > indexOf.changelog;
							})).length > 0)){
								var i = idx[0] + version_header.length;
								deployer.log.silly("WORDPRESS-UPGRADE => Found Changelog version header");
								content = [content.slice(0, i), out.changelog + "\n", content.slice(i)].join('');
							} else {
								// If no Changelog header
								deployer.log.silly("WORDPRESS-UPGRADE => Did not found Changelog version header");
								content = content.replace(/(== Changelog ==)/, "$1\n\n= " + deployer.config.version + " =\n" + out.changelog);
							}

							if((indexOf.changelog > indexOf.upgrade_notice &amp;&amp; (idx = version_headers.filter(function(elem){
								return elem &lt; indexOf.changelog &amp;&amp; elem > indexOf.upgrade_notice;
							})).length > 0) || (indexOf.changelog &lt; indexOf.upgrade_notice &amp;&amp; (idx = version_headers.filter(function(elem){
								return elem > indexOf.upgrade_notice;
							})).length > 0)){
								var i = idx[0] + version_header.length;
								deployer.log.silly("WORDPRESS-UPGRADE => Found Upgrade Notice version header");
								content = [content.slice(0, i), out.upgrade_notice + "\n", content.slice(i)].join('');
							} else {
								// If no Upgrade Notice header
								deployer.log.silly("WORDPRESS-UPGRADE => Did not found Upgrade Notice version header");
								content = content.replace(/(== Upgrade Notice ==)/, "$1\n\n= " + deployer.config.version + " =\n" + out.upgrade_notice);
							}
						}
						fs.writeFile(fp, content, function(err){
							cb2(err);
						});
					}, function(err){
						if(err){
							deployer.log.error(err);
							return cb(err);
						}
						return cb();
					});
				} else {
					deployer.log.error("WORDPRESS-UPGRADE => Incoherent versions! Stop here");
					return cb("WORDPRESS-UPGRADE => Incoherent versions! Stop here");
				}
			});
		});
	}
}

function textEditor(filepath, initialFileContent, commandObject, cb){
	fs.writeFile(filepath, initialFileContent, function(err){
		if(err)
			deployer.log.error(err);
		deployer.log.silly("WORDPRESS-UPGRADE => Creating text-editor instance with config",commandObject);
		var texteditor = child_process.spawn(commandObject.bin, commandObject.args, {stdio: 'inherit'});
		texteditor.on('exit', function(err, ret){
			if(err){
				deployer.log.error("WORDPRESS-UPGRADE => Error while executing text editor...", err);
			}
			fs.readFile(filepath, "UTF-8", function(err, content){
				if(err){
					deployer.log.error("WORDPRESS-UPGRADE => Error while reading temp file " + filepath);
					return cb(err, "");
				}
				fs.unlink(filepath, function(err){
					if(err){
						deployer.log.warn("WORDPRESS-UPGRADE => Could not remove temp file " + filepath);
					}
					return cb(0,content.trim());
				});
			});
		});
	});
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-actions_cp.html">actions/cp</a></li><li><a href="module-actions_exec.html">actions/exec</a></li><li><a href="module-actions_files-version.html">actions/files-version</a></li><li><a href="module-actions_git.html">actions/git</a></li><li><a href="module-actions_minify.html">actions/minify</a></li><li><a href="module-actions_svn.html">actions/svn</a></li><li><a href="module-actions_version-history.html">actions/version-history</a></li><li><a href="module-actions_wordpress-upgrade.html">actions/wordpress-upgrade</a></li><li><a href="module-deployer.html">deployer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deployer">deployer</a></li><li><a href="global.html#getFilesRec">getFilesRec</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Mar 31 2016 19:39:17 GMT-0930 (MART)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
