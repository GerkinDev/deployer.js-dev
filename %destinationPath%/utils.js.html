<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Global functions used through Deployer.js package
 * @description Retrieve all files from path, excluding ones in the {@link deployer}.config.excludeExplore
 *
 * @author false
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPL v3
 * @package deployer.js
 *
 * @version 0.2.1
 */

throwError = function(error, critical){
}/*
	if(typeof critical == "undefined"){
		critical = false;
	}

	var text = colour["italic"](JSON.stringify(error));
	if(critical){
		deployer.log.error(text);
		process.exit(1);
	} else {
		deployer.log.warn(text);
	}
}*/

/**
 *
 * @method getFilesRec
 * @param {callback} cb Callback to call afterwards. Returns (err, files)
 * @returns {undefined}
 */
getFilesRec = function(path, cb){
	var out = [];
	var dirs = {};
	fs.readdir(path, function(err, files){
		if(err){
			throwError(err);
		}
		async.each(files, function(file, cb1){
			// Used with fs
			var filepath = path + "/" + file;
			// Used for regex match
			var transformedPath = filepath.replace(process.cwd(), '.');
			fs.stat(filepath, function(err, stat){
				if(err){
					throwError(err);
				} else {
					if(stat.isDirectory()){

						var isOk = true;
						for(var i = 0, j = deployer.config.excludeExplore.length &amp;&amp; isOk; i &lt; j; i++){
							var excludedPath = deployer.config.excludeExplore[i];
							if(transformedPath.match(new RegExp(excludedPath))){
								isOk = false;
							}
						}
						if(isOk){
							getFilesRec(filepath, function(err, subfiles){
								if(err){
									throwError(err);
								}
								dirs[file] = subfiles;
								cb1()
							});
						} else {
							cb1();
						}
					} else {
						out.push(file);
						cb1();
					}
				}
			});
		}, function(err){
			if(Object.keys(dirs).length > 0){
				out.push(dirs);
			}
			cb(err, out);
		});
	})
}

checkFiles = function(files, regex, status, basePath, force){
	if(typeof basePath == "undefined"){
		basePath = ".";
	}
	if(typeof force == "undefined"){
		force = false;
	}
	for(var file in files){
		var match = (basePath + "/" + file).match(regex);
		if(force || match){
			if(typeof files[file] == "boolean"){
				files[file] = status
			} else {
				files[file].included = status;
			}
		}
		if(typeof files[file] != "boolean"){
			files[file].files = checkFiles(files[file].files, regex, status, basePath + "/" + file, force ||Â match);
		}
	}
	return files;
}

reformatFiles = function(files){
	var ret = {};
	for(var i = 0, j = files.length; i &lt; j; i++){
		if(typeof files[i] === "object"){
			for(var k = Object.keys(files[i]), l = 0, m = k.length; l &lt; m; l++){
				ret[k[l]] = {included: false, files: reformatFiles(files[i][k[l]])};
			}
		} else {
			ret[files[i]] = false;
		}
	}
	return ret;
}

filesStructToArray = function(files, basepath){
	if(typeof basepath == "undefined"){
		basepath = ".";
	}
	var ret = [];
	for(var file in files){
		var filepath = basepath + "/" + file;
		if(typeof files[file] == "boolean"){
			if(files[file]){
				ret.push(filepath);
			}
		} else {
			ret = ret.concat(filesStructToArray(files[file].files, filepath));
		}
	}
	return ret;
}

replacePlaceHolders = function(obj, args){
	if(obj == null){
		return obj;
	} else if(typeof obj == "object" &amp;&amp; obj != null &amp;&amp; obj.constructor != Array){
		var ret = {};
		for(var i in obj){
			ret[i] = replacePlaceHolders(obj[i],args);
		}
		return ret;
	} else if(obj.constructor == Array){
		var ret = [];
		for(var i = 0, j = obj.length; i &lt; j; i++){
			ret.push(replacePlaceHolders(obj[i],args));
		}
		return ret;
	} else if(typeof obj == "string"){
		return deepReplacePlaceholder("", obj, args);
	} else {
		return obj;
	}
}
function deepReplacePlaceholder(prefix, value, replacements){
	var replacementsKeys = Object.keys(replacements);
	for(var i = 0, j = replacementsKeys.length; i &lt; j; i++){
		var replacementKey = replacementsKeys[i];
		var replacement = replacements[replacementKey];
		if(replacement.constructor.name == "String"){
			console.log(prefix+replacementKey, replacement);
			value = value.replace(new RegExp("([^\\\\]|^)%"+prefix+replacementKey+"%", "gm"), "$1"+replacement);
		} else {
			console.log("Going depth into replace placeholder");
			value = deepReplacePlaceholder(prefix+replacementKey + ".", value, replacement);
		}
	}
	return value;
}

mkdir = function(path, root) {

	var dirs = path.split('/'), dir = dirs.shift(), root = (root || '') + dir + '/';

	try { fs.mkdirSync(root); }
	catch (e) {
		//dir wasn't made, something went wrong
		if(!fs.statSync(root).isDirectory()) throw new Error(e);
	}

	return !dirs.length || mkdir(dirs.join('/'), root);
}

composeUrl = function(args, from, to){
	var composed = deployer.config.project.documentation.format.slice(from, to).join("/");
	if(args.base == "url"){
		composed = composed.replace("%BASE%", deployer.config.project.documentation.base.url)
	} else if(args.base == "path"){
		composed = composed.replace("%BASE%", deployer.config.project.documentation.base.path);
	}
	if(args.type){
		composed = composed.replace("%TYPE%", args.type);
	}
	return composed;
}

readLocalConfigFile = function(cb){
	var file = path.resolve(".", deployer.config.configFile);
	fs.readFile(file, 'UTF-8', function(err, filecontent){
		if(err){
			return cb(err);
		}
		try{
			var configFile = JSON.parse(filecontent);
		} catch(e) {
			deployer.log.warn("Invalid JSON file " + file,e);
			return cb(e);
		}
		return cb(null,configFile);
	});
}

writeLocalConfigFile = function(filecontent, cb){
	var file = path.resolve(".", deployer.config.configFile);
	fs.writeFile(file, JSON.stringify(filecontent,null,4), function(err){
		cb(err);
	});
}

getModuleVersion = function(moduleName, callback){
	if(!deployer.config.moduleVersion)
		deployer.config.moduleVersion = {};
	fs.readFile(path.resolve(moduleName.match(/\.js$/) ? moduleName : moduleName + ".js"), "UTF-8", function(err, content){
		if(err){
			deployer.log.error("Could not find module \"" + moduleName + "\"");
			deployer.config.moduleVersion[moduleName] = "unknown"
		} else {
			var version = content.match(/^\/\*\*(?:\s*\*\s*(?:(@version.*)|.*)?)+\//m);
			if(version[1] &amp;&amp; content.indexOf(version) &lt; content.indexOf("*/")){
				deployer.config.moduleVersion[moduleName] = version[1].replace(/@version\s+/,"");
			} else {replacePlaceHolders
			deployer.config.moduleVersion[moduleName] = "unknown";
				   }
		}
		callback();
	});
}

var enqueuedPrompts = [];
var runningPromp = null;
requestPrompt = function(question, callback){
	if(runningPromp == null){
		runningPromp = {question: question, cb: callback};
		rl.question(question, function(value){
			runningPromp.cb(value); // Call this prompt request callback
			runningPromp = null;
			if(enqueuedPrompts.length > 0){ // If other prompts were enqueued
				var newPrompt = enqueuedPrompts[0];
				enqueuedPrompts.slice(1);
				return requestPrompt(newPrompt.question, newPrompt.cb); // Execute the next prompt
			}
		})
	} else {
		enqueuedPrompts.push({question: question, cb: callback});
	}
}

transformArguments = function(parent, newArgs, callback){
	newArgs = replacePlaceHolders(newArgs,parent);
	var args = merge(parent, true);
	async.forEachOf(newArgs, function(newArg, key, cb){
		console.log("Handling", key, newArg);
		if(newArg &amp;&amp; newArg.constructor &amp;&amp; newArg.constructor.name === "Object"){ // If this is an object, it must be a special function
			switch(newArg.type){
				case "regex_replace":{
					console.log(newArg.value.match(new RegExp(newArg.search)));
					args[key] = newArg.value.replace(new RegExp(newArg.search), newArg.replacement);
					return cb();
				} break;

				case "prompt":{
					return requestPrompt("Please provide a value for argument \"" + key + "\": ", function(val){
						args[key] = val;
						return cb();
					});
				} break;
			}
		} else {
			args[key] = newArg;
			return cb();
		}
	}, function(err){
		console.log("TransformArguments:", args);
		callback(err,args);
	});
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-actions_cp.html">actions/cp</a></li><li><a href="module-actions_exec.html">actions/exec</a></li><li><a href="module-actions_files-version.html">actions/files-version</a></li><li><a href="module-actions_git.html">actions/git</a></li><li><a href="module-actions_minify.html">actions/minify</a></li><li><a href="module-actions_svn.html">actions/svn</a></li><li><a href="module-actions_version-history.html">actions/version-history</a></li><li><a href="module-actions_wordpress-upgrade.html">actions/wordpress-upgrade</a></li><li><a href="module-deployer.html">deployer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deployer">deployer</a></li><li><a href="global.html#getFilesRec">getFilesRec</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Mar 31 2016 19:39:17 GMT-0930 (MART)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
