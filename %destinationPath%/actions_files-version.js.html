<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: actions/files-version.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: actions/files-version.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Set version at changes
 * @description Set version at changes
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPL v3
 * @package deployer.js
 *
 * @version 0.2.1
 */

const checksum = require('checksum');
const readline = require('readline');

/**
 * @todo description {@link deployer}
 * @module actions/files-version
 * @requires fs
 * @requires readline
 * @requires checksum
 */
module.exports = {
	/**
	 * @method process
	 * @static
	 * @memberof module:actions/files-version
	 * @param   {object} config Options to explain to the module how to behave
	 * @param   {callback} cb Function to call at the end of action
	 * @returns {undefined}
	 * @description Browse each file in `files`, check if they changed, then rewrite them by changing their version header 
	 */
	process: function(config, cb){
		console.log("In files-version",config);
		var reformatedFiles = reformatFiles(deployer.files);
		var selectors = Object.keys(config.selection)
		for(var i = 0, j = selectors.length; i &lt; j; i++){
			var selector = selectors[i];
			try{
				var regex = new RegExp(selector);
			} catch(e){
				deployer.log.error(e);
			}
			reformatedFiles = checkFiles(reformatedFiles, regex, config.selection[selector]);
		}
		var filesArray = filesStructToArray(reformatedFiles);

		var checksums = {};

		async.each(filesArray, function(file, cb1){
			var filepath = path.resolve(".", file);
			makeChecksums(filepath, function(err, returns){
				checksums[file] = returns
				cb1(err);
			});
		}, function(err){
			if(err){
				deployer.log.error(err);
				return cb(err);
			}
			return readLocalConfigFile(function(err, localConfig){
				if(err){
					deployer.log.error(err);
					return cb(err);
				}
				if(!localConfig)
					return cb("FILES-VERSION => Could not read config file");

				var filesChecked = [];
				async.forEachOfSeries(checksums, function(checksum, file, cb1){
					var localConfigChecksum = (localConfig.project.checksums ? localConfig.project.checksums[file] : false);
					if(!localConfigChecksum){
						deployer.log.silly("FILES-VERSION => File " + file + " is new");
						return fileChanged(file, config.arguments.version, function(err, newChecksums){
							if(err){
								deployer.log.error(err)
								return cb1(err);
							}
							checksums[file] = newChecksums;
							return cb1(err);
						});
					} else {
						var typesums = Object.keys(
							localConfigChecksum
						).concat(
							Object.keys(
								checksum
							)
						).filter(
							function(v,i,s){
								return s.indexOf(v)===i;
							}
						);
						var changed = false;
						for(var i = 0, j = typesums.length; i &lt; j; i++){
							var type = typesums[i];
							changed |= (typeof checksum[type] != "undefined" &amp;&amp; checksum[type] != null &amp;&amp; typeof localConfigChecksum[type] != "undefined" &amp;&amp; localConfigChecksum[type] != null &amp;&amp; localConfigChecksum[type] != checksum[type]);
						}
						if(changed){
							deployer.log.silly("FILES-VERSION => File " + file + " changed");
							return fileChanged(file, config.targetVersion, function(err, newChecksums){
								if(err){
									deployer.log.error(err)
									checksums[file] = {};
									return cb1(err);
								}
								checksums[file] = newChecksums;
								return cb1(err);
							});
						} else {
							deployer.log.silly("FILES-VERSION => File " + file + " has the same checksums");
							checksums[file] = localConfigChecksum;
							return cb1();
						}
					}
				}, function(err){
					// Rewrite checksums
					localConfig.project.checksums = checksums;
					return writeLocalConfigFile(localConfig, cb);
				});
			});
		});
	},
	arguments: "version"
}

function fileChanged(file, version, cb){
	var regexHeader = new RegExp((file.match(/\.php$/) ? "&lt;\\?php[\\n\\s]*(?:.*\\n)?" : "^") + "(\\/\\*\\*\\n(?:\\s*\\*\\s*(?:@?.*)?\\n)*\\s*\\*\\/)");
	var filepath = path.resolve(".", file);
	fs.readFile(filepath, "UTF-8", function(err, content){
		var header = content.match(regexHeader);
		var infos = {
			fd:{
				file: false,
				description: false
			},
			legal:{
				"author":false,
				"copyright":false,
				"license":false,
				"package":false,
			},
			other:{},
			version:{
				version: false
			}
		};
		if(header != null &amp;&amp; header.length >= 2 &amp;&amp; header[1])
			header = header[1];
		if(!header){
			deployer.log.warn("FILES-VERSION => File " + file + " has no file header");
		} else {
			deployer.log.info("FILES-VERSION => File " + file + " has changed");
			var splitInfos = /^[\f\t ]*\*[\f\t ]*(?!\/)(?:@(\w+))?[\f\t ]*(.*)??$/gm;
			var splittedHeader = header.match(splitInfos);
			var requiredInfos = ["file", "copyright", "license", "package", "author", "version"];
			for(var i = 0, j = splittedHeader.length; i &lt; j; i++){
				var info = splittedHeader[i].match(new RegExp(splitInfos.source));
				if(typeof info[1] == "undefined"){
					if(typeof info[2] != "undefined"){
						infos["fd"]["description"] = (infos["fd"]["description"] ? infos["fd"]["description"] : "") + info[2];
					}
				} else {
					var index = requiredInfos.indexOf(info[1]);
					if(index > -1)
						requiredInfos.splice(index, 1);
					switch(info[1]){
						case "file":{
							infos["fd"]["file"] = info[2];
						} break;

						case "description":
						case "desc": {
							infos["fd"]["description"] = (infos["fd"]["description"] ? infos["fd"]["description"] : "") + info[2];
						} break;

						case "copyright":
						case "license":
						case "package":
						case "author":{
							infos["legal"][info[1]] = info[2];
						} break;

						case "version":{
							infos["version"][info[1]] = info[2];
						} break;

						default:{
							infos["other"][info[1]] = info[2];
						} break;
					}
				}
			}
		}
		checkHeaderDatas(infos, file, function(infosMod){
			infosMod["version"]["version"] = version;
			if(Object.keys(infosMod["other"]).length == 0)
				delete infosMod["other"];
			var docblock = "/**";
			for(var type in infosMod){
				docblock += "\n";
				for(var data in infosMod[type]){
					if(infosMod[type][data]){
						docblock += " * @" + data + " " + infosMod[type][data] + "\n";
					}
				}
				docblock += " *";
			}
			docblock += "/";
			if(header){
				content = content.replace(header, docblock);
			} else {
				var isPhp = file.match(/\.php$/);
				content = content.replace(new RegExp("(" + (isPhp ? "&lt;\\?php" : "^") + ")"), "$1" + (isPhp ? "\n\n" : "") + docblock + "\n\n");
			}
			return fs.writeFile(filepath, content, function(err){
				if(err){
					deployer.log.warn("FILES-VERSION => Error while rewriting " + file + "");
					return cb(err)
				}
				makeChecksums(filepath, cb);
			});
		});
	});
}

function makeChecksums(file, cb){
	async.parallel({
		sha1: function(cb2){
			checksum.file(file, {algorithm:"sha1"}, cb2);
		},
		md5: function(cb2){
			checksum.file(file, {algorithm:"md5"}, cb2);
		}
	}, cb);
}

function checkHeaderDatas(infos, file, cb){
	var headWasLogged = false;
	const rl = readline.createInterface({
		input: process.stdin,
		output: process.stdout
	});
	async.series([
		function(cb1){
			if(!infos["fd"]["file"]){
				if(!headWasLogged){
					console.log("==> For file " + file);
					headWasLogged = true;
				}
				requestPrompt("Please provide a file description: ", function(value){
					infos["fd"]["file"] = value;
					cb1();
				});
			} else {
				cb1();
			}
		},
		function(cb1){
			if(!infos["legal"]["copyright"]){
				var y = (new Date()).getFullYear();
				infos["legal"]["copyright"] = y + " " + deployer.config.project.company.name
			}
			cb1();
		},
		function(cb1){
			if(!infos["legal"]["license"]){
				if(!headWasLogged){
					console.log("==> For file " + file);
					headWasLogged = true;
				}
				requestPrompt("Please give the URL to the license: ", function(url){
					requestPrompt("Please provide the license name: ", function(name){
						infos["legal"]["license"] = url + " " + name;
						cb1();
					});
				});
			} else {
				cb1();
			}
		},
		function(cb1){
			if(!infos["legal"]["package"]){
				if(!headWasLogged){
					console.log("==> For file " + file);
					headWasLogged = true;
				}
				requestPrompt("Please provide a package name: ", function(name){
					infos["legal"]["package"] = name;
					cb1();
				});
			} else {
				cb1();
			}
		},
		function(cb1){
			if(!infos["legal"]["package"]){
				if(!headWasLogged){
					console.log("==> For file " + file);
					headWasLogged = true;
				}
				requestPrompt("Please provide the author name: ", function(name){
					infos["legal"]["author"] = name;
					cb1();
				});
			} else {
				cb1();
			}
		},
	], function(){
		rl.close();
		cb(infos);
	});
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-actions_cp.html">actions/cp</a></li><li><a href="module-actions_exec.html">actions/exec</a></li><li><a href="module-actions_files-version.html">actions/files-version</a></li><li><a href="module-actions_git.html">actions/git</a></li><li><a href="module-actions_minify.html">actions/minify</a></li><li><a href="module-actions_svn.html">actions/svn</a></li><li><a href="module-actions_version-history.html">actions/version-history</a></li><li><a href="module-actions_wordpress-upgrade.html">actions/wordpress-upgrade</a></li><li><a href="module-deployer.html">deployer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deployer">deployer</a></li><li><a href="global.html#getFilesRec">getFilesRec</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Mar 31 2016 19:39:17 GMT-0930 (MART)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
