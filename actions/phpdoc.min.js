/**
 * @file Generates the documentation of javascript
 * @description Generates the documentation of javascript
 *
 * @author Gerkin
 * @copyright 2016 GerkinDevelopment
 * @license http://www.gnu.org/licenses/gpl-3.0.en.html GPL v3
 * @package deployer.js
 *
 * @version 0.2.2
 */
const xmlbuilder=require("xmlbuilder"),randomstring=require("randomstring"),replace=require("replace");module.exports={process:function(e,r){var o=filesFromSelectors(e.selection),t=o.length;if(0==t)return deployer.log.info("PHPDOC => No files to document with phpdoc"),r();for(var p=0;t>p;p++)o[p]=path.resolve(".",o[p]);var l=xmlbuilder.create("phpdoc",{version:"1.0",encoding:"UTF-8"});l.ele("title",deployer.config.project.project_name),l.ele("author",deployer.config.project.author);var a=l.ele("parser");a.ele("target","data/output"),a.ele("encoding","utf8");var n=a.ele("extensions");n.ele({extension:["php","php3","phtml"]});var c=a.ele("markers");c.ele({item:["TODO","FIXME"]}),l.ele({logging:{level:"quiet",paths:{"default":path.resolve(".","logs/phpdoc/{DATE}.log"),errors:path.resolve(".","logs/phpdoc/{DATE}.error.log")}}}),l.ele({transformer:{target:"data/output"}}),l.ele({files:{file:o}});var i=l.ele("transformations");for(var s in e.templates){var u={template:{"@name":s}};e.templates[s].length&&(u.template.parameters={variables:e.templates[s]}),i.ele(u)}var d="phpdoc-"+randomstring.generate(15)+"-config.xml",f=path.resolve("/tmp",d);fs.writeFile(f,l.end({pretty:!0}),function(o){var t=[];e["private"]&&t.push("--parseprivate"),t.push("-t"),t.push(composeUrl({base:"path",type:e.typepath},0,3)),t.push("-c"),t.push(f),deployer.log.info('PHPDOC => Command: "'+t+'"');var p=child_process.spawn("phpdoc",t);p.stdout.on("data",function(e){deployer.log.verbose("PHPDoc =>",e.toString("UTF-8").slice(0,-1))}),p.stderr.on("data",function(e){deployer.log.error("PHPDoc =>",e.toString("UTF-8").slice(0,-1))}),p.on("exit",function(o){deployer.log.info("PHPDOC => Process PHPDOC exited with code "+o),e.replace_output&&"Object"==e.replace_output.constructor.name&&Object.keys(e.replace_output).length>0?getFilesRec(composeUrl({base:"path",type:e.typepath},0,3),function(o,t){t=reformatFiles(t),t=checkFiles(t,/\.html$/,!0),t=filesStructToArray(t);t.length;if(deployer.config.project.company){if(deployer.config.project.company.start){var p=(new Date).getFullYear();p!=deployer.config.project.company.start&&(p=deployer.config.project.company.start+" - "+p),e.replace_output["%COMPANY-YEAR%"]=p}deployer.config.project.company.name&&(e.replace_output["%COMPANY-NAME%"]=deployer.config.project.company.name)}async.each(t,function(r,o){var t=path.resolve(composeUrl({base:"path",type:e.typepath},0,3),r);fs.readFile(t,"UTF-8",function(r,p){r&&deployer.log.error("PHPDOC => Error while read",t,r);for(var l in e.replace_output){var a="\\["+l+"\\]",n=new RegExp(a,"g");p=p.replace(n,e.replace_output[l])}fs.writeFile(t,p,o)})},function(e){e&&deployer.log.error(e),r(e)})}):fs.unlink(f,function(e){e&&deployer.warn("PHPDOC => Could not unlink config file "+f),r()})})})}};